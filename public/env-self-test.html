<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduEasy Environment Self-Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .test-section {
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background: #f8f9fa;
    }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #ffc107; font-weight: bold; }
    .info { color: #17a2b8; font-weight: bold; }
    pre {
      background-color: #f1f3f4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      border-left: 4px solid #667eea;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
      margin-left: 8px;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-error { background: #f8d7da; color: #721c24; }
    .badge-warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß™ EduEasy Environment Self-Test</h1>
    <p>Diagnostic tool for Supabase configuration priority and runtime setup</p>
  </div>
  
  <div id="results">Loading tests...</div>

  <script src="/runtime-config.js"></script>
  <script type="module">
    const resultsDiv = document.getElementById('results');
    
    // URL parameter helpers
    const getUrlParam = (key) => {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    };
    
    // Environment resolution logic (matches src/lib/env.ts)
    const getEnvVar = (key) => {
      // 1. URL parameters
      const urlParam = getUrlParam(key.replace('VITE_', '').toLowerCase());
      if (urlParam) return urlParam;
      
      // Handle specific mappings
      if (key === 'VITE_SUPABASE_URL') {
        const sbUrl = getUrlParam('sbUrl');
        if (sbUrl) return sbUrl;
      }
      
      if (key === 'VITE_SUPABASE_ANON_KEY') {
        const sbAnon = getUrlParam('sbAnon');
        if (sbAnon) return sbAnon;
      }
      
      // 2. Runtime config
      if (window.__RUNTIME_CONFIG__ && window.__RUNTIME_CONFIG__[key]) {
        return window.__RUNTIME_CONFIG__[key];
      }
      
      // 3. Import.meta.env (not available in this context)
      return undefined;
    };
    
    const getEnvSource = () => {
      if (getUrlParam('sbUrl') || getUrlParam('sbAnon')) return 'url-params';
      if (window.__RUNTIME_CONFIG__ && 
          (window.__RUNTIME_CONFIG__.VITE_SUPABASE_URL || window.__RUNTIME_CONFIG__.VITE_SUPABASE_ANON_KEY)) {
        return 'runtime-config.js';
      }
      return 'import.meta.env';
    };
    
    try {
      const supabaseUrl = getEnvVar('VITE_SUPABASE_URL');
      const supabaseKey = getEnvVar('VITE_SUPABASE_ANON_KEY');
      const activeSource = getEnvSource();
      
      let html = '';
      
      // Environment Source Test
      html += `
        <div class="test-section">
          <h2>üéØ Environment Source Priority</h2>
          <p><strong>Active Source:</strong> <span class="info">${activeSource}</span>
          <span class="badge ${activeSource === 'runtime-config.js' ? 'badge-success' : 'badge-warning'}">${activeSource}</span></p>
          <p><strong>Priority Order:</strong> URL params ‚Üí runtime-config.js ‚Üí import.meta.env</p>
        </div>
      `;
      
      // Configuration Values Test
      html += `
        <div class="test-section">
          <h2>üîß Configuration Values</h2>
      `;
      
      if (supabaseUrl) {
        const maskedUrl = supabaseUrl.substring(0, 20) + '...';
        html += `<p class="success">‚úì VITE_SUPABASE_URL: ${maskedUrl}</p>`;
      } else {
        html += `<p class="error">‚úó VITE_SUPABASE_URL: Not found</p>`;
      }
      
      if (supabaseKey) {
        const maskedKey = supabaseKey.substring(0, 12) + '...' + supabaseKey.substring(supabaseKey.length - 8);
        html += `<p class="success">‚úì VITE_SUPABASE_ANON_KEY: ${maskedKey}</p>`;
      } else {
        html += `<p class="error">‚úó VITE_SUPABASE_ANON_KEY: Not found</p>`;
      }
      
      html += `</div>`;
      
      // Runtime Config Test
      html += `
        <div class="test-section">
          <h2>üöÄ Runtime Configuration</h2>
      `;
      
      if (window.__RUNTIME_CONFIG__) {
        html += `<p class="success">‚úì Runtime config object loaded</p>`;
        html += `<pre>${JSON.stringify(window.__RUNTIME_CONFIG__, null, 2)}</pre>`;
      } else {
        html += `<p class="error">‚úó Runtime config object not found</p>`;
      }
      
      html += `</div>`;
      
      // URL Override Test
      html += `
        <div class="test-section">
          <h2>üîÄ URL Parameter Override Test</h2>
          <p>Current URL parameters:</p>
          <ul>
      `;
      
      const params = new URLSearchParams(window.location.search);
      if (params.toString()) {
        for (const [key, value] of params) {
          html += `<li><strong>${key}:</strong> ${key.includes('sb') ? value.substring(0, 20) + '...' : value}</li>`;
        }
      } else {
        html += `<li><em>No URL parameters detected</em></li>`;
      }
      
      html += `
          </ul>
          <p><strong>Test URLs:</strong></p>
          <ul>
            <li><a href="/env-self-test.html">Default (runtime-config.js)</a></li>
            <li><a href="/env-self-test.html?sbUrl=https://example.supabase.co&sbAnon=test-key">URL Override Test</a></li>
          </ul>
        </div>
      `;
      
      // Summary
      const allGood = supabaseUrl && supabaseKey && window.__RUNTIME_CONFIG__;
      html += `
        <div class="test-section">
          <h2>üìã Summary</h2>
          <p class="${allGood ? 'success' : 'error'}">
            ${allGood ? '‚úÖ All systems operational' : '‚ùå Configuration issues detected'}
          </p>
          <p><strong>Source:</strong> ${activeSource}</p>
          <p><strong>Supabase URL:</strong> ${supabaseUrl ? '‚úì Set' : '‚úó Missing'}</p>
          <p><strong>Supabase Key:</strong> ${supabaseKey ? '‚úì Set' : '‚úó Missing'}</p>
        </div>
      `;
      
      resultsDiv.innerHTML = html;
      
    } catch (error) {
      resultsDiv.innerHTML = `
        <div class="test-section">
          <h2>‚ùå Test Error</h2>
          <p class="error">Error: ${error.message}</p>
          <pre>${error.stack || 'No stack trace available'}</pre>
        </div>
      `;
    }
  </script>
</body>
</html>